{"title":"安全权限框架之-springboot整合shiro","date":"2019-10-31T09:20:58.000Z","link":"2019/10/31/安全权限框架之-springboot整合shiro","tags":["Java","Shiro","SpringBoot"],"updated":"2019-11-08T06:49:20.147Z","content":"<p><img src=\"http://148.70.50.70/source/1571404808823.jpg\" alt=\"image.png\" class=\"article-img\"></p>\n<p><strong>Subject</strong>：可以理解为与shiro打交道的对象，该对象封装了一些对方的信息，shiro可以通过subject拿到这些信息</p>\n<p><strong>SecurityManage</strong>r：Shiro的总经理，通过指使Authorizer和Authenticator等对subject进行授权和身份验证等工作</p>\n<p><strong>Realm</strong>：管理着一些如用户、角色、权限等重要信息，Shiro中所需的这些重要信息都是从Realm这里获取的，Realm本质上就是一个重要信息的数据源</p>\n<p><strong>Authenticator</strong>：认证器，负责Subject的认证操作，认证过程就是根据Subject提供的信息通过Realm查询到相关信息，然后做对比，支持扩展</p>\n<p><strong>Authorizer</strong>：授权器，控制着Subject对服务资源的访问权限</p>\n<p><strong>SessionManager</strong>：用于管理Session，这个Session可以是web的也可以不是web的。</p>\n<p><strong>SessionDao</strong>：把Session的 CRUD和存储介质联系起来的工具，存储介质可以是数据库，也可以是缓存，比如把session放到redis里面</p>\n<p><strong>CacheManager</strong>：缓存控制器，Realm管理的数据（用户、角色、权限）可以放到缓存里由CacheManager管理，提高认证授权等的速度</p>\n<p><strong>Cryptography</strong>：加密组件，Shiro提供了很多加解密算法的组件</p>\n<h3 id=\"接下来我们开始简单的整合\">接下来我们开始简单的整合<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#接下来我们开始简单的整合\"></a></h3><h4 id=\"pom-xml添加\">pom.xml添加<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#pom-xml添加\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.3.2&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></div></figure>\n\n<h4 id=\"第一步就是手写一个配置类，命名为ShiroConfig\">第一步就是手写一个配置类，命名为ShiroConfig<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#第一步就是手写一个配置类，命名为ShiroConfig\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.LinkedHashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ShiroConfig</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Bean</span>(name = <span class=\"string\">\"shiroFilter\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ShiroFilterFactoryBean <span class=\"title\">shiroFilter</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class=\"keyword\">new</span> ShiroFilterFactoryBean();</span><br><span class=\"line\">        shiroFilterFactoryBean.setSecurityManager(securityManager());</span><br><span class=\"line\">        shiroFilterFactoryBean.setLoginUrl(<span class=\"string\">\"/none\"</span>);</span><br><span class=\"line\">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class=\"string\">\"/none\"</span>);</span><br><span class=\"line\">        Map&lt;String,String&gt; map = <span class=\"keyword\">new</span> LinkedHashMap&lt;String,String&gt;();</span><br><span class=\"line\">        <span class=\"comment\">/*anon表示可以匿名访问，authc表示必须认证通过才能访问*/</span></span><br><span class=\"line\">        map.put(<span class=\"string\">\"/list\"</span>,<span class=\"string\">\"anon\"</span>);</span><br><span class=\"line\">        map.put(<span class=\"string\">\"/login\"</span>,<span class=\"string\">\"anon\"</span>);</span><br><span class=\"line\">        map.put(<span class=\"string\">\"/info\"</span>,<span class=\"string\">\"authc\"</span>);</span><br><span class=\"line\">        <span class=\"comment\">/*这行代码需要放在所有权限设置的最后，不然会导致所有的url被拦截，剩余的都需要认证*/</span></span><br><span class=\"line\">        map.put(<span class=\"string\">\"/**\"</span>,<span class=\"string\">\"authc\"</span>);</span><br><span class=\"line\">        shiroFilterFactoryBean.setFilterChainDefinitionMap(map);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> shiroFilterFactoryBean;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span>(name = <span class=\"string\">\"securityManager\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> DefaultWebSecurityManager <span class=\"title\">securityManager</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        DefaultWebSecurityManager defaultWebSecurityManager = <span class=\"keyword\">new</span> DefaultWebSecurityManager();</span><br><span class=\"line\">        defaultWebSecurityManager.setRealm(realm());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> defaultWebSecurityManager;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span>(name = <span class=\"string\">\"realm\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Realm <span class=\"title\">realm</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Realm();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>这里有三个Bean，需要自己操作的就是shiroFilter和realm，shiroFilter设置过滤器，realm是一个继承AuthorizingRealm的类，需要实现两个方法doGetAuthorizationInfo和doGetAuthenticationInfo执行授权与认证。除此之外，设置了四个url  /none /list /login /info,<br>/none为未登录与认证跳转的url，/list和/login为不用认证的url，/info为需要认证的url。</p>\n<h4 id=\"接下来手写Realm类\">接下来手写Realm类<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#接下来手写Realm类\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import org.apache.shiro.SecurityUtils;</span><br><span class=\"line\">import org.apache.shiro.authc.*;</span><br><span class=\"line\">import org.apache.shiro.authz.AuthorizationInfo;</span><br><span class=\"line\">import org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class=\"line\">import org.apache.shiro.realm.AuthorizingRealm;</span><br><span class=\"line\">import org.apache.shiro.subject.PrincipalCollection;</span><br><span class=\"line\"></span><br><span class=\"line\">import java.util.HashMap;</span><br><span class=\"line\">import java.util.HashSet;</span><br><span class=\"line\">import java.util.Set;</span><br><span class=\"line\"></span><br><span class=\"line\">public class Realm extends AuthorizingRealm &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    @Override</span><br><span class=\"line\">    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) &#123;</span><br><span class=\"line\">        System.out.println(&quot;执行授权逻辑&quot;);</span><br><span class=\"line\">        return null;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    /*身份认证*/</span><br><span class=\"line\">    @Override</span><br><span class=\"line\">    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException &#123;</span><br><span class=\"line\">        System.out.println(&quot;执行认证逻辑&quot;);</span><br><span class=\"line\">        /*这里账户密码模拟数据库*/</span><br><span class=\"line\">        String username = &quot;qwer&quot;;</span><br><span class=\"line\">        String password = &quot;1234&quot;;</span><br><span class=\"line\">        /*获取用户认证传来的封装的账户密码令牌*/</span><br><span class=\"line\">        UsernamePasswordToken token = (UsernamePasswordToken)authenticationToken;</span><br><span class=\"line\">        /*返回用户名不存在，底层抛出UnKnowAccountException异常*/</span><br><span class=\"line\">        if(!token.getUsername().equals(username))&#123;</span><br><span class=\"line\">            return null;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return new SimpleAuthenticationInfo(&quot;&quot;,password,&quot;&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<h4 id=\"Controller，在Controller中写刚刚的几个url\">Controller，在Controller中写刚刚的几个url<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#Controller，在Controller中写刚刚的几个url\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import org.apache.shiro.SecurityUtils;</span><br><span class=\"line\">import org.apache.shiro.authc.*;</span><br><span class=\"line\">import org.apache.shiro.subject.Subject;</span><br><span class=\"line\">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class=\"line\">import org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class=\"line\">import org.springframework.web.bind.annotation.*;</span><br><span class=\"line\"></span><br><span class=\"line\">import java.util.ArrayList;</span><br><span class=\"line\">import java.util.HashMap;</span><br><span class=\"line\">import java.util.List;</span><br><span class=\"line\">import java.util.concurrent.TimeUnit;</span><br><span class=\"line\"></span><br><span class=\"line\">@RestController</span><br><span class=\"line\">public class test &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    @RequestMapping(&quot;/list&quot;)</span><br><span class=\"line\">    public List&lt;HashMap&lt;String,Integer&gt;&gt; Map()&#123;</span><br><span class=\"line\">        List&lt;HashMap&lt;String,Integer&gt;&gt; list = new ArrayList&lt;&gt;();</span><br><span class=\"line\">        HashMap&lt;String,Integer&gt; map = new HashMap&lt;&gt;();</span><br><span class=\"line\">        map.put(&quot;One&quot;,1);</span><br><span class=\"line\">        map.put(&quot;Two&quot;,2);</span><br><span class=\"line\">        map.put(&quot;Three&quot;,3);</span><br><span class=\"line\">        HashMap&lt;String,Integer&gt; map0 = new HashMap&lt;&gt;();</span><br><span class=\"line\">        map0.put(&quot;One&quot;,1);</span><br><span class=\"line\">        map0.put(&quot;Two&quot;,2);</span><br><span class=\"line\">        map0.put(&quot;Three&quot;,3);</span><br><span class=\"line\">        list.add(map);</span><br><span class=\"line\">        list.add(map0);</span><br><span class=\"line\">        return list;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    @RequestMapping(&quot;/none&quot;)</span><br><span class=\"line\">    public String none()&#123;</span><br><span class=\"line\">        return &quot;You can&apos;t get the service&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    @RequestMapping(&quot;/info&quot;)</span><br><span class=\"line\">    public String info()&#123;</span><br><span class=\"line\">        return &quot;This is info required login&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    @RequestMapping(&quot;/login&quot;)</span><br><span class=\"line\">    public String Login(@RequestParam(&quot;username&quot;) String username,@RequestParam(&quot;password&quot;)String password)&#123;</span><br><span class=\"line\">        /*创建一个subject*/</span><br><span class=\"line\">        Subject subject = SecurityUtils.getSubject();</span><br><span class=\"line\">        /*封装用户数据*/</span><br><span class=\"line\">        UsernamePasswordToken token = new UsernamePasswordToken(username,password);</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            /*执行登录,然后这里会跳转到Realm的认证逻辑中*/</span><br><span class=\"line\">            subject.login(token);</span><br><span class=\"line\">            return &quot;登陆成功&quot;;</span><br><span class=\"line\">        &#125; catch (UnknownAccountException uae) &#123;</span><br><span class=\"line\">            return &quot;未知账户&quot;;</span><br><span class=\"line\">        &#125; catch (IncorrectCredentialsException ice) &#123;</span><br><span class=\"line\">            return &quot;密码不正确&quot;;</span><br><span class=\"line\">        &#125; catch (LockedAccountException lae) &#123;</span><br><span class=\"line\">            return &quot;账户已锁定&quot;;</span><br><span class=\"line\">        &#125; catch (ExcessiveAttemptsException eae) &#123;</span><br><span class=\"line\">            return &quot;用户名或密码错误次数过多&quot;;</span><br><span class=\"line\">        &#125; catch (AuthenticationException ae) &#123;</span><br><span class=\"line\">            return &quot;用户名或密码不正确！&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<h4 id=\"接下来使用postman进行接口测试\">接下来使用postman进行接口测试<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#接下来使用postman进行接口测试\"></a></h4><h5 id=\"输入不需要认证的url-“-list”进行测试\">输入不需要认证的url “/list”进行测试<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#输入不需要认证的url-“-list”进行测试\"></a></h5><p><img src=\"http://148.70.50.70/source/1571623692995.jpg\" alt=\"image.png\"><br>顺利获取接口提供数据</p>\n<h5 id=\"输入需要认证的url进行测试\">输入需要认证的url进行测试<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#输入需要认证的url进行测试\"></a></h5><p><img src=\"http://148.70.50.70/source/1571623564852.jpg\" alt=\"image.png\"><br>发现跳转到了/none页面，这是因为未执行认证。</p>\n<h5 id=\"现在开始认证\">现在开始认证<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#现在开始认证\"></a></h5><p><img src=\"http://148.70.50.70/source/1571623796384.jpg\" alt=\"image.png\"><br>认证成功</p>\n<h5 id=\"再次输入需要认证的url-“-info”\">再次输入需要认证的url “/info”<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#再次输入需要认证的url-“-info”\"></a></h5><p><img src=\"http://148.70.50.70/source/1571623838500.jpg\" alt=\"image.png\"><br>成功获取接口数据</p>\n<h4 id=\"角色和权限的关系\">角色和权限的关系<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#角色和权限的关系\"></a></h4><p><img src=\"http://148.70.50.70/source/1571672890938.jpg\" alt=\"image.png\" class=\"article-img\"></p>\n<p>那么最基本的使用已经说完了，现在开始实战部分</p>\n<h4 id=\"首先是数据库设计，先给出一个简单的数据表\">首先是数据库设计，先给出一个简单的数据表<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#首先是数据库设计，先给出一个简单的数据表\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DROP TABLE IF EXISTS `user_role` ;</span><br><span class=\"line\">DROP TABLE IF EXISTS `role_permission` ;</span><br><span class=\"line\">DROP TABLE IF EXISTS `user` ;</span><br><span class=\"line\">DROP TABLE IF EXISTS `role` ;</span><br><span class=\"line\">DROP TABLE IF EXISTS `permission` ;</span><br><span class=\"line\"></span><br><span class=\"line\"># 用户表</span><br><span class=\"line\">CREATE TABLE `user` (`id` BIGINT PRIMARY KEY NOT NULL ,`username` VARCHAR (20),`password` VARCHAR(300));</span><br><span class=\"line\"># 角色表</span><br><span class=\"line\">CREATE TABLE `role` (`id` BIGINT PRIMARY KEY NOT NULL ,`description` VARCHAR(3600),`role` VARCHAR(3600));</span><br><span class=\"line\"># 权限表</span><br><span class=\"line\">CREATE TABLE `permission` (`id` BIGINT PRIMARY KEY NOT NULL ,`name` VARCHAR(200),`description` VARCHAR(3600));</span><br><span class=\"line\"># 用户角色表</span><br><span class=\"line\">CREATE TABLE `user_role` (`user_id` BIGINT, `role_id` BIGINT,</span><br><span class=\"line\">    FOREIGN KEY (`user_id`) REFERENCES `user`(`id`),</span><br><span class=\"line\">        FOREIGN KEY (`role_id`) REFERENCES `role`(`id`));</span><br><span class=\"line\"># 角色权限表</span><br><span class=\"line\">CREATE TABLE `role_permission` (`role_id` BIGINT, `permission_id` BIGINT,</span><br><span class=\"line\">                          FOREIGN KEY (`role_id`) REFERENCES `role`(`id`),</span><br><span class=\"line\">                          FOREIGN KEY (`permission_id`) REFERENCES `permission`(`id`));</span><br><span class=\"line\"></span><br><span class=\"line\"># 一个用户可以有多个角色，每个角色有不同的权限，可以有多个权限</span><br><span class=\"line\">INSERT `user` (id, username, password) VALUES (10000,&apos;normal&apos;,&apos;1234&apos;);</span><br><span class=\"line\">INSERT `user` (id, username, password) VALUES (10001,&apos;vip1&apos;,&apos;1234&apos;);</span><br><span class=\"line\">INSERT `user` (id, username, password) VALUES (10002,&apos;vip2&apos;,&apos;1234&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">INSERT `role` (id, description, role) VALUES (10000,&apos;没啥权限，底层贫穷用户。&apos;,&apos;普通用户&apos;);</span><br><span class=\"line\">INSERT `role` (id, description, role) VALUES (10001,&apos;vip黄金会员，拥有观看独播视频和更换皮肤的功能。&apos;,&apos;vip黄金会员&apos;);</span><br><span class=\"line\">INSERT `role` (id, description, role) VALUES (10002,&apos;vip白金会员，拥有vip黄金会员的所有权限，还有不限速功能&apos;,&apos;vip白金会员&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\"># INSERT `permission` (id, name, description) VALUES (10000,&apos;normal&apos;,&apos;观看普通视频&apos;);</span><br><span class=\"line\">INSERT `permission` (id, name, description) VALUES (10000,&apos;vip1&apos;,&apos;观看独播视频&apos;);</span><br><span class=\"line\">INSERT `permission` (id, name, description) VALUES (10001,&apos;vip1&apos;,&apos;更换高级皮肤&apos;);</span><br><span class=\"line\">INSERT `permission` (id, name, description) VALUES (10002,&apos;vip2&apos;,&apos;缓存不限速&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\"># 添加角色权限</span><br><span class=\"line\">INSERT `role_permission` (role_id, permission_id) VALUES (10001, 10000);</span><br><span class=\"line\">INSERT `role_permission` (role_id, permission_id) VALUES (10001, 10001);</span><br><span class=\"line\"></span><br><span class=\"line\">INSERT `role_permission` (role_id, permission_id) VALUES (10002, 10000);</span><br><span class=\"line\">INSERT `role_permission` (role_id, permission_id) VALUES (10002, 10001);</span><br><span class=\"line\">INSERT `role_permission` (role_id, permission_id) VALUES (10002, 10002);</span><br><span class=\"line\"></span><br><span class=\"line\"># 添加用户角色</span><br><span class=\"line\">INSERT `user_role` (user_id, role_id) VALUES (10000, 10000);</span><br><span class=\"line\">INSERT `user_role` (user_id, role_id) VALUES (10001, 10001);</span><br><span class=\"line\">INSERT `user_role` (user_id, role_id) VALUES (10002, 10002);</span><br><span class=\"line\"></span><br><span class=\"line\"># 获取角色id</span><br><span class=\"line\">SELECT `user_role`.`role_id` FROM `user_role` WHERE `user_id` = 10001;</span><br><span class=\"line\"># 获取该角色的权限</span><br><span class=\"line\">SELECT `role_permission`.`permission_id` FROM `role_permission` WHERE `role_id` IN(SELECT `user_role`.`role_id` FROM `user_role` WHERE `user_id` = 10000);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">SELECT `role`.`role` FROM `role` WHERE `role`.`id` IN (SELECT `user_role`.`role_id` FROM `user_role` WHERE `user_id` = 10002);</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT `permission`.* FROM `permission` WHERE `permission`.`id` IN</span><br><span class=\"line\">    (SELECT `role_permission`.`permission_id` FROM `role_permission` WHERE `role_id` IN</span><br><span class=\"line\">        (SELECT `role`.`id` FROM `role` WHERE `role`.`id` IN</span><br><span class=\"line\">            (SELECT `user_role`.`role_id` FROM `user_role` WHERE `user_id` = 10001)));</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT * FROM user;</span><br></pre></td></tr></table></div></figure>\n<p>这就是一个简单的数据库设计，需要五张表</p>\n<blockquote>\n<p>user -用户表</p>\n</blockquote>\n<blockquote>\n<p>role -角色表</p>\n</blockquote>\n<blockquote>\n<p>permission -权限表</p>\n</blockquote>\n<blockquote>\n<p>user_role -用户角色表</p>\n</blockquote>\n<blockquote>\n<p>role_permission -角色权限表</p>\n</blockquote>\n<p>用户表就是普通的用户表</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class User implements Serializable &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    private Integer id;</span><br><span class=\"line\">    private String username;</span><br><span class=\"line\">    private String password;</span><br><span class=\"line\"></span><br><span class=\"line\">    /*get and set*/</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>角色表</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Role &#123;</span><br><span class=\"line\">    private int id;</span><br><span class=\"line\">    private String description;</span><br><span class=\"line\">    private String role;</span><br><span class=\"line\"></span><br><span class=\"line\">    /*get and set*/</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>权限表</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Permission &#123;</span><br><span class=\"line\">    private Integer id;</span><br><span class=\"line\">    private String name;</span><br><span class=\"line\">    private String description;</span><br><span class=\"line\">    /*get and set*/</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>其他两个表不用创建实体类，这里的用户可以对应多个角色，每个角色可以对应多个权限，比如腾讯QQ的普通用户和vip用户，普通用户无法享受更换高级装饰的功能，但是vip用户可以。在这里，普通用户和vip用户是角色，更换高级装饰功能是权限，是vip特有的权限，所以数据表user_role与role_permission要对应这种关系。</p>\n<h4 id=\"接下来要写几个接口，一个是通过用户id获取该用户所拥有的角色，一个是通过用户id获取该用户角色拥有的权限，一个是通过用户名查找id（毕竟用户输入账户不会输入id）\">接下来要写几个接口，一个是通过用户id获取该用户所拥有的角色，一个是通过用户id获取该用户角色拥有的权限，一个是通过用户名查找id（毕竟用户输入账户不会输入id）<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#接下来要写几个接口，一个是通过用户id获取该用户所拥有的角色，一个是通过用户id获取该用户角色拥有的权限，一个是通过用户名查找id（毕竟用户输入账户不会输入id）\"></a></h4><h5 id=\"DAO数据层使用简单的-Mapper注解\">DAO数据层使用简单的@Mapper注解<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#DAO数据层使用简单的-Mapper注解\"></a></h5><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Select(&quot;SELECT `permission`.* FROM `permission` WHERE `permission`.`id` IN\\n&quot; +</span><br><span class=\"line\">        &quot;    (SELECT `role_permission`.`permission_id` FROM `role_permission` WHERE `role_id` IN\\n&quot; +</span><br><span class=\"line\">        &quot;        (SELECT `role`.`id` FROM `role` WHERE `role`.`id` IN\\n&quot; +</span><br><span class=\"line\">        &quot;            (SELECT `user_role`.`role_id` FROM `user_role` WHERE `user_id` = #&#123;id&#125;)));&quot;)</span><br><span class=\"line\">List&lt;Permission&gt; getPermissionByUserId(Integer id);</span><br><span class=\"line\"></span><br><span class=\"line\">@Select(&quot;SELECT `role`.* FROM `role` WHERE `role`.`id` IN (SELECT `user_role`.`role_id` FROM `user_role` WHERE `user_id` = #&#123;id&#125;);&quot;)</span><br><span class=\"line\">List&lt;Role&gt; getRoleByUserId(Integer id);</span><br><span class=\"line\"></span><br><span class=\"line\">@Select(&quot;SELECT `user`.* FROM `user` WHERE `user`.`username` = #&#123;username&#125;;&quot;)</span><br><span class=\"line\">User getUserByUsername(String username);</span><br></pre></td></tr></table></div></figure>\n<h5 id=\"业务层接口\">业务层接口<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#业务层接口\"></a></h5><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">List&lt;Permission&gt; getPermissionByUserId(Integer id);</span><br><span class=\"line\">List&lt;Role&gt; getRoleByUserId(Integer id);</span><br><span class=\"line\">User getUserByUsername(String username);</span><br></pre></td></tr></table></div></figure>\n<h5 id=\"注入service业务层接口实现\">注入service业务层接口实现<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#注入service业务层接口实现\"></a></h5><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Override</span><br><span class=\"line\">public List&lt;Permission&gt; getPermissionByUserId(Integer id) &#123;</span><br><span class=\"line\">    return userDao.getPermissionByUserId(id);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@Override</span><br><span class=\"line\">public List&lt;Role&gt; getRoleByUserId(Integer id) &#123;</span><br><span class=\"line\">    return userDao.getRoleByUserId(id);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@Override</span><br><span class=\"line\">public User getUserByUsername(String username) &#123;</span><br><span class=\"line\">    return userDao.getUserByUsername(username);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<h5 id=\"现在认证可以使用数据库了\">现在认证可以使用数据库了<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#现在认证可以使用数据库了\"></a></h5><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/*身份认证*/</span><br><span class=\"line\">@Override</span><br><span class=\"line\">protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException &#123;</span><br><span class=\"line\">    System.out.println(&quot;执行认证逻辑&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    UsernamePasswordToken token = (UsernamePasswordToken)authenticationToken;</span><br><span class=\"line\"></span><br><span class=\"line\">    User user = userService.getUserByUsername(token.getUsername());</span><br><span class=\"line\"></span><br><span class=\"line\">    if(user == null)&#123;</span><br><span class=\"line\">        return null;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    /*设置用户session*/</span><br><span class=\"line\">    Session session = SecurityUtils.getSubject().getSession();</span><br><span class=\"line\">    session.setAttribute(&quot;user&quot;,user);</span><br><span class=\"line\">    System.out.println(session.getId());</span><br><span class=\"line\"></span><br><span class=\"line\">    return new SimpleAuthenticationInfo( (String)token.getPrincipal(), user.getPassword(),getName());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<h5 id=\"授权\">授权<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#授权\"></a></h5><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Override</span><br><span class=\"line\">protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) &#123;</span><br><span class=\"line\">    System.out.println(&quot;执行授权逻辑&quot;);</span><br><span class=\"line\">    SimpleAuthorizationInfo authorizationInfo = new SimpleAuthorizationInfo();</span><br><span class=\"line\">    String username = (String) SecurityUtils.getSubject().getPrincipal();</span><br><span class=\"line\"></span><br><span class=\"line\">    Set&lt;String&gt; roles = new HashSet&lt;&gt;();</span><br><span class=\"line\">    Set&lt;String&gt; permissions = new HashSet&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    User user = userService.getUserByUsername(username);</span><br><span class=\"line\"></span><br><span class=\"line\">    /*获取并添加该用户角色*/</span><br><span class=\"line\">    List&lt;Role&gt; roleList = userService.getRoleByUserId(user.getId());</span><br><span class=\"line\">    for(Role role: roleList)&#123;</span><br><span class=\"line\">        roles.add(role.getRole());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    /*获取并添加该用户权限*/</span><br><span class=\"line\">    List&lt;Permission&gt; permissionList = userService.getPermissionByUserId(user.getId());</span><br><span class=\"line\">    for(Permission permission: permissionList)&#123;</span><br><span class=\"line\">        permissions.add(permission.getName());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    authorizationInfo.addRoles(roles);</span><br><span class=\"line\">    authorizationInfo.addStringPermissions(permissions);</span><br><span class=\"line\"></span><br><span class=\"line\">    return authorizationInfo;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>这里添加的角色是role.getRole()，权限是permission.getName()，如果使用的字段不同，对应的角色与权限名也不同，比如role为”vip白金会员”，则需要”vip白金会员”这个角色字符串，permission为”vip1”则需要permission为”vip1”。<br>至此，已经通过用户登录后通过session保持会话，那么如何设置角色或者权限拦截呢？</p>\n<h4 id=\"有两种方法，一种是在控制层添加注解\">有两种方法，一种是在控制层添加注解<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#有两种方法，一种是在控制层添加注解\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@RequiresPermissions(&quot;vip1&quot;)</span><br><span class=\"line\">@RequestMapping(&quot;/vip1&quot;)</span><br><span class=\"line\">public String vip1()&#123;</span><br><span class=\"line\">    return &quot;This is vip1 content(尊贵vip1接口)&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@RequiresPermissions(&quot;vip2&quot;)</span><br><span class=\"line\">@RequestMapping(&quot;/vip2&quot;)</span><br><span class=\"line\">public String vip2()&#123;</span><br><span class=\"line\">    return &quot;This is vip2 content(尊贵vip2接口)&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@RequiresRoles(&quot;vip黄金会员&quot;)</span><br><span class=\"line\">@RequestMapping(&quot;/vip1_role&quot;)</span><br><span class=\"line\">public String vip1_role()&#123;</span><br><span class=\"line\">    return &quot;This is vip 黄金会员&quot;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>如果要使用注解，必须要在ShiroConfig中添加下面的代码开启注解，否则无效</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/*开启注解*/</span><br><span class=\"line\">@Bean</span><br><span class=\"line\">public DefaultAdvisorAutoProxyCreator advisorAutoProxyCreator() &#123;</span><br><span class=\"line\">    DefaultAdvisorAutoProxyCreator advisorAutoProxyCreator = new DefaultAdvisorAutoProxyCreator();</span><br><span class=\"line\">    advisorAutoProxyCreator.setProxyTargetClass(true);</span><br><span class=\"line\">    return advisorAutoProxyCreator;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@Bean</span><br><span class=\"line\">public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor() &#123;</span><br><span class=\"line\">    AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = new AuthorizationAttributeSourceAdvisor();</span><br><span class=\"line\">    authorizationAttributeSourceAdvisor.setSecurityManager(securityManager());</span><br><span class=\"line\">    return authorizationAttributeSourceAdvisor;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>访问/vip1接口就需要所需权限，未登录情况下<br><img src=\"http://148.70.50.70/source/1571804377475.jpg\" alt=\"image.png\"><br>登陆后<br><img src=\"http://148.70.50.70/source/1571804400820.jpg\" alt=\"image.png\"><br>访问<br><img src=\"http://148.70.50.70/source/1571804418056.jpg\" alt=\"image.png\"></p>\n<p><img src=\"http://148.70.50.70/source/1571804434170.jpg\" alt=\"image.png\"><br>因为数据库中已经设定vip2也拥有vip1的所有权限，所以vip2用户可以访问vip1和vip2两个接口，但是如果登录vip1账户，只能访问vip1接口，vip2则访问不了。</p>\n<h4 id=\"另一种方法，在ShiroConfig中添加拦截页面，拦截页面已经在上面说过\">另一种方法，在ShiroConfig中添加拦截页面，拦截页面已经在上面说过<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#另一种方法，在ShiroConfig中添加拦截页面，拦截页面已经在上面说过\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">map.put(&quot;/perms&quot;,&quot;perms[vip2]&quot;);</span><br></pre></td></tr></table></div></figure>\n<p>这样就需要vip2的权限才能访问”/perms”这个接口了，添加角色拦截也是一样，甚至数据库两个表也行，就user与role两个表也能达到安全管理的作用。</p>\n<h5 id=\"设置没有权限返回的接口\">设置没有权限返回的接口<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#设置没有权限返回的接口\"></a></h5><p>添加一个抛出无权限异常的类</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/*无权限异常抛出类*/</span><br><span class=\"line\"></span><br><span class=\"line\">@ControllerAdvice</span><br><span class=\"line\">public class Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    @ExceptionHandler</span><br><span class=\"line\">    @ResponseBody</span><br><span class=\"line\">    public String ErrotHandler(AuthorizationException e)&#123;</span><br><span class=\"line\">        return &quot;Sorry,you don&apos;t have permission.&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<h4 id=\"Shiro-md5加密，加盐\">Shiro md5加密，加盐<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#Shiro-md5加密，加盐\"></a></h4><p>安全起见，一般数据库中都不会保存明文的密码，通过md5这种非对称性算法，将密码加密后存储到数据库中，这种非对称性加密是单向的，通过转换后的密码无法解密成真实密码，所以用户如果忘记密码无法找回密码。但是只用md5加密有可能造成许多用户的密码重复，如一些简单的1234诸如此类的密码，所以再次通过数据库中唯一的id来加盐，达到密码唯一的效果。</p>\n<h6 id=\"在ShiroConfig类中加入Bean\">在ShiroConfig类中加入Bean<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#在ShiroConfig类中加入Bean\"></a></h6><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**加密方式*/</span></span><br><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> HashedCredentialsMatcher <span class=\"title\">hashedCredentialsMatcher</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    HashedCredentialsMatcher hashedCredentialsMatcher = <span class=\"keyword\">new</span> HashedCredentialsMatcher();</span><br><span class=\"line\">    hashedCredentialsMatcher.setHashAlgorithmName(<span class=\"string\">\"md5\"</span>);</span><br><span class=\"line\">    hashedCredentialsMatcher.setHashIterations(<span class=\"number\">3</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 默认是true，true使用Hex编码；false使用Base64编码</span></span><br><span class=\"line\">    hashedCredentialsMatcher.setStoredCredentialsHexEncoded(ture);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> hashedCredentialsMatcher;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<h6 id=\"修改ShiroConfig类中的Bean-Realm\">修改ShiroConfig类中的Bean-Realm<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#修改ShiroConfig类中的Bean-Realm\"></a></h6><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> DefaultAdvisorAutoProxyCreator <span class=\"title\">advisorAutoProxyCreator</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    DefaultAdvisorAutoProxyCreator advisorAutoProxyCreator = <span class=\"keyword\">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class=\"line\">    advisorAutoProxyCreator.setProxyTargetClass(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> advisorAutoProxyCreator;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>这样在执行认证逻辑的时候，Shiro会将用户的密码加密成配置的加密密文，与数据库中的密文进行对比，在此之前，还要根据配置的加密方式自己制定相应的加密方法。</p>\n<h6 id=\"添加一个容器类Encryption\">添加一个容器类Encryption<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#添加一个容器类Encryption\"></a></h6><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.apache.shiro.crypto.hash.SimpleHash;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.shiro.util.ByteSource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Encryption</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">md5Encryption</span><span class=\"params\">(String username, String password)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> SimpleHash</span><br><span class=\"line\">                (<span class=\"string\">\"MD5\"</span>, password, ByteSource.Util.bytes</span><br><span class=\"line\">                        (username), <span class=\"number\">3</span>).toHex();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>然后用户注册的时候，通过注入方法来加密到数据库。</p>\n<h6 id=\"最后修改下Realm的认证逻辑\">最后修改下Realm的认证逻辑<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#最后修改下Realm的认证逻辑\"></a></h6><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**身份认证*/</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> AuthenticationInfo <span class=\"title\">doGetAuthenticationInfo</span><span class=\"params\">(AuthenticationToken authenticationToken)</span> <span class=\"keyword\">throws</span> AuthenticationException </span>&#123;</span><br><span class=\"line\">    System.out.println(<span class=\"string\">\"执行认证逻辑\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    UsernamePasswordToken token = (UsernamePasswordToken)authenticationToken;</span><br><span class=\"line\"></span><br><span class=\"line\">    User user = userService.getUserByUsername(token.getUsername());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(user == <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), ByteSource.Util.bytes(user.getUsername()), getName());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>大功告成</p>\n<h4 id=\"设置rememberMe状态保留\">设置rememberMe状态保留<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#设置rememberMe状态保留\"></a></h4><p>登陆成功后，关闭浏览器然后再次进入权限接口，会跳转到无权限的接口（页面），为了实现remember me的需求，让我们关闭浏览器后再次打开浏览器能够继续访问权限接口，需要在shiro中进行一些配置。</p>\n<h6 id=\"添加两个Bean\">添加两个Bean<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#添加两个Bean\"></a></h6><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**配置cookie，设置用户cookie失效时间，实现rememberMe功能。*/</span></span><br><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> SimpleCookie <span class=\"title\">simpleCookie</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    SimpleCookie cookie = <span class=\"keyword\">new</span> SimpleCookie(<span class=\"string\">\"rememberMe\"</span>);</span><br><span class=\"line\">    cookie.setMaxAge(<span class=\"number\">500</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> cookie;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**管理对象*/</span></span><br><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> CookieRememberMeManager <span class=\"title\">cookieRememberMeManager</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    CookieRememberMeManager rememberMeManager = <span class=\"keyword\">new</span> CookieRememberMeManager();</span><br><span class=\"line\">    rememberMeManager.setCookie(simpleCookie());</span><br><span class=\"line\">    rememberMeManager.setCipherKey(Base64.decode(<span class=\"string\">\"4AvVhmFLUs0KTA3Kprsdag==\"</span>));</span><br><span class=\"line\">    <span class=\"keyword\">return</span> rememberMeManager;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<h6 id=\"然后添加到SecurityManager中注入上面两个Bean\">然后添加到SecurityManager中注入上面两个Bean<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#然后添加到SecurityManager中注入上面两个Bean\"></a></h6><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span>(name = <span class=\"string\">\"securityManager\"</span>)</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> DefaultWebSecurityManager <span class=\"title\">securityManager</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    DefaultWebSecurityManager defaultWebSecurityManager =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> DefaultWebSecurityManager();</span><br><span class=\"line\">    defaultWebSecurityManager.setRealm(realm());</span><br><span class=\"line\">    defaultWebSecurityManager.setRememberMeManager(cookieRememberMeManager());</span><br><span class=\"line\">    <span class=\"keyword\">return</span> defaultWebSecurityManager;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<h6 id=\"在ShiroFilterFactoryBean中设置接口（页面）\">在ShiroFilterFactoryBean中设置接口（页面）<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#在ShiroFilterFactoryBean中设置接口（页面）\"></a></h6><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Bean(name = &quot;shiroFilter&quot;)</span><br><span class=\"line\">public ShiroFilterFactoryBean shiroFilter()&#123;</span><br><span class=\"line\">    ShiroFilterFactoryBean shiroFilterFactoryBean =</span><br><span class=\"line\">            new ShiroFilterFactoryBean();</span><br><span class=\"line\">    shiroFilterFactoryBean.setSecurityManager(securityManager());</span><br><span class=\"line\">    shiroFilterFactoryBean.setLoginUrl(&quot;/none&quot;);</span><br><span class=\"line\">    shiroFilterFactoryBean.setUnauthorizedUrl(&quot;/none&quot;);</span><br><span class=\"line\">    Map&lt;String,String&gt; map = new LinkedHashMap&lt;String,String&gt;();</span><br><span class=\"line\">    map.put(&quot;/list&quot;,&quot;anon&quot;);</span><br><span class=\"line\">    map.put(&quot;/login&quot;,&quot;anon&quot;);</span><br><span class=\"line\">    map.put(&quot;/test&quot;,&quot;anon&quot;);</span><br><span class=\"line\">    map.put(&quot;/info&quot;,&quot;user&quot;);</span><br><span class=\"line\">    // 可以使用过滤器拦截未授权url，也可以使用注解*/</span><br><span class=\"line\">    map.put(&quot;/perms&quot;,&quot;perms[vip2]&quot;);</span><br><span class=\"line\">    map.put(&quot;/*&quot;,&quot;authc&quot;);</span><br><span class=\"line\">    shiroFilterFactoryBean.setFilterChainDefinitionMap(map);</span><br><span class=\"line\"></span><br><span class=\"line\">    return shiroFilterFactoryBean;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>可以看到 “/info” 接口的value值为 “user”，这样 “/info” 接口在浏览器退出后，再次进入浏览器可以无需登录访问。</p>\n<h6 id=\"最后在-login-接口中\">最后在 /login 接口中<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#最后在-login-接口中\"></a></h6><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@RequestMapping(&quot;/login&quot;)</span><br><span class=\"line\">public String login(@RequestParam(&quot;username&quot;) String username, @RequestParam(&quot;password&quot;)String password, @RequestParam(value = &quot;remember&quot;, required = true, defaultValue = &quot;false&quot;)boolean remember)&#123;</span><br><span class=\"line\">    /**创建一个subject*/</span><br><span class=\"line\">    Subject subject = SecurityUtils.getSubject();</span><br><span class=\"line\">    /**封装用户数据*/</span><br><span class=\"line\">    UsernamePasswordToken token = new UsernamePasswordToken(username, password, remember);</span><br><span class=\"line\"></span><br><span class=\"line\">    /**执行登录,然后这里会跳转到Realm的认证逻辑中*/</span><br><span class=\"line\">    subject.login(token);</span><br><span class=\"line\">    token.setRememberMe(remember);</span><br><span class=\"line\">    HttpSession session = request.getSession();</span><br><span class=\"line\">    session.setAttribute(&quot;user&quot;, subject.getPrincipal());</span><br><span class=\"line\">    return session.getId();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>remember默认为false</p>\n<h6 id=\"测试\">测试<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#测试\"></a></h6><p>首先设置remember为false</p>\n<p><img src=\"http://148.70.50.70/source/1573195336847.jpg\" alt=\"image.png\" class=\"article-img\"></p>\n<p><img src=\"http://148.70.50.70/source/1573195656698.jpg\" alt=\"image.png\" class=\"article-img\"></p>\n<p>登陆成功且接口正常访问。然后退出浏览器。再次访问接口。</p>\n<p><img src=\"http://148.70.50.70/source/1573195510558.jpg\" alt=\"image.png\" class=\"article-img\"></p>\n<p>可以发现无法访问。接下来设置rememberMe为true</p>\n<p><img src=\"http://148.70.50.70/source/1573195603643.jpg\" alt=\"image.png\" class=\"article-img\"></p>\n<p>退出浏览器后，再次访问。</p>\n<p><img src=\"C:%5CUsers%5CNICE%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1573195740184.png\" alt=\"1573195740184\" class=\"article-img\"></p>\n<p>测试成功！</p>\n<h4 id=\"Shiro登陆失败次数限制\">Shiro登陆失败次数限制<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#Shiro登陆失败次数限制\"></a></h4><p>为了防止暴力破解密码，需要对登录次数进行限制，失败次数达到一定次数后，规定时间内限制其再次登陆。首先用户表需要添加status字段。</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class User implements Serializable &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    private Integer id;</span><br><span class=\"line\">    private String username;</span><br><span class=\"line\">    private String password;</span><br><span class=\"line\">\tprivate Integer status;</span><br><span class=\"line\">    /*get and set*/</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>然后在Realm认证逻辑中，1表示已经被锁定，0表示正常。</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/**身份认证*/</span><br><span class=\"line\">@Override</span><br><span class=\"line\">protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException &#123;</span><br><span class=\"line\">    System.out.println(&quot;执行认证逻辑&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    UsernamePasswordToken token = (UsernamePasswordToken)authenticationToken;</span><br><span class=\"line\"></span><br><span class=\"line\">    User user = userService.getUserByUsername(token.getUsername());</span><br><span class=\"line\"></span><br><span class=\"line\">    if(user == null)&#123;</span><br><span class=\"line\">        return null;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    if(user.getStatus == 1)&#123;</span><br><span class=\"line\">        throw new LockedAccountException(&quot;Account Locked.&quot;);</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        return new SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), ByteSource.Util.bytes(user.getUsername()), getName());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>然后配置搞缓存和在错误登陆的时候+1 balabalabala</p>\n<h3 id=\"数据库表设计\">数据库表设计<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#数据库表设计\"></a></h3><h4 id=\"用户表\">用户表<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#用户表\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE TABLE `user` (</span><br><span class=\"line\">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class=\"line\">  `user_id` varchar(20) NOT NULL COMMENT &apos;用户id&apos;,</span><br><span class=\"line\">  `username` varchar(50) NOT NULL COMMENT &apos;用户名&apos;,</span><br><span class=\"line\">  `password` varchar(50) NOT NULL,</span><br><span class=\"line\">  `salt` varchar(128) DEFAULT NULL COMMENT &apos;加密盐值&apos;,</span><br><span class=\"line\">  `email` varchar(50) DEFAULT NULL COMMENT &apos;邮箱&apos;,</span><br><span class=\"line\">  `phone` varchar(50) DEFAULT NULL COMMENT &apos;联系方式&apos;,</span><br><span class=\"line\">  `sex` int(255) DEFAULT NULL COMMENT &apos;年龄：1男2女&apos;,</span><br><span class=\"line\">  `age` int(3) DEFAULT NULL COMMENT &apos;年龄&apos;,</span><br><span class=\"line\">  `status` int(1) NOT NULL COMMENT &apos;用户状态：1有效; 2删除&apos;,</span><br><span class=\"line\">  `create_time` datetime DEFAULT NULL COMMENT &apos;创建时间&apos;,</span><br><span class=\"line\">  `update_time` datetime DEFAULT NULL COMMENT &apos;更新时间&apos;,</span><br><span class=\"line\">  `last_login_time` datetime DEFAULT NULL COMMENT &apos;最后登录时间&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`id`,`user_id`)</span><br><span class=\"line\">) ENGINE=InnoDB AUTO_INCREMENT=24 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></div></figure>\n<h4 id=\"角色表\">角色表<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#角色表\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE TABLE `role` (</span><br><span class=\"line\">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class=\"line\">  `role_id` varchar(20) NOT NULL COMMENT &apos;角色id&apos;,</span><br><span class=\"line\">  `name` varchar(50) NOT NULL COMMENT &apos;角色名称&apos;,</span><br><span class=\"line\">  `description` varchar(255) DEFAULT NULL COMMENT &apos;角色描述&apos;,</span><br><span class=\"line\">  `status` int(1) NOT NULL COMMENT &apos;状态：1有效；2删除&apos;,</span><br><span class=\"line\">  `create_time` datetime DEFAULT NULL COMMENT &apos;创建时间&apos;,</span><br><span class=\"line\">  `update_time` datetime DEFAULT NULL COMMENT &apos;更新时间&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`id`)</span><br><span class=\"line\">) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></div></figure>\n<h4 id=\"权限表\">权限表<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#权限表\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE TABLE `permission` (</span><br><span class=\"line\">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class=\"line\">  `permission_id` varchar(20) NOT NULL COMMENT &apos;权限id&apos;,</span><br><span class=\"line\">  `name` varchar(100) NOT NULL COMMENT &apos;权限名称&apos;,</span><br><span class=\"line\">  `description` varchar(255) DEFAULT NULL COMMENT &apos;权限描述&apos;,</span><br><span class=\"line\">  `url` varchar(255) DEFAULT NULL COMMENT &apos;权限访问路径&apos;,</span><br><span class=\"line\">  `perms` varchar(255) DEFAULT NULL COMMENT &apos;权限标识&apos;,</span><br><span class=\"line\">  `parent_id` int(11) DEFAULT NULL COMMENT &apos;父级权限id&apos;,</span><br><span class=\"line\">  `type` int(1) DEFAULT NULL COMMENT &apos;类型   0：目录   1：菜单   2：按钮&apos;,</span><br><span class=\"line\">  `order_num` int(3) DEFAULT &apos;0&apos; COMMENT &apos;排序&apos;,</span><br><span class=\"line\">  `icon` varchar(50) DEFAULT NULL COMMENT &apos;图标&apos;,</span><br><span class=\"line\">  `status` int(1) NOT NULL COMMENT &apos;状态：1有效；2删除&apos;,</span><br><span class=\"line\">  `create_time` datetime DEFAULT NULL,</span><br><span class=\"line\">  `update_time` datetime DEFAULT NULL,</span><br><span class=\"line\">  PRIMARY KEY (`id`)</span><br><span class=\"line\">) ENGINE=InnoDB AUTO_INCREMENT=32 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></div></figure>\n<h4 id=\"用户角色关系表\">用户角色关系表<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#用户角色关系表\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE TABLE `user_role` (</span><br><span class=\"line\">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class=\"line\">  `user_id` varchar(20) NOT NULL COMMENT &apos;用户id&apos;,</span><br><span class=\"line\">  `role_id` varchar(20) NOT NULL COMMENT &apos;角色id&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`id`)</span><br><span class=\"line\">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></div></figure>\n<h4 id=\"角色权限关系表\">角色权限关系表<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#角色权限关系表\"></a></h4><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE TABLE `role_permission` (</span><br><span class=\"line\">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class=\"line\">  `role_id` varchar(20) NOT NULL COMMENT &apos;角色id&apos;,</span><br><span class=\"line\">  `permission_id` varchar(20) NOT NULL COMMENT &apos;权限id&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`id`)</span><br><span class=\"line\">) ENGINE=InnoDB AUTO_INCREMENT=869 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></div></figure>\n<h4 id=\"session会话管理\">session会话管理<a href=\"2019/10/31/安全权限框架之-springboot整合shiro#session会话管理\"></a></h4><p><img src=\"http://148.70.50.70/source/1571762848189.jpg\" alt=\"image.png\" class=\"article-img\"></p>\n","prev":{"title":"Linux安装使用阿里云镜像","link":"2019/10/31/Linux安装使用阿里云镜像"},"next":{"title":"整理了2019年Java面试题（集 合+并发+调优+微服务+spring+Redis）（转载）","link":"2019/10/30/整理了2019年Java面试题（集 合+并发+调优+微服务+spring+Redis）（转载）"},"plink":"http://yoursite.com/2019/10/31/安全权限框架之-springboot整合shiro/"}